import{scope}from"./gconsole.min.js";function simulacion2doOrden(entrada,valor_anterior,valor_anterior2,gain,tao1,tao2,dt){if(Array.isArray(arguments[0])){var args=[...arguments].join().split(",");entrada=Number(args[0]);valor_anterior=Number(args[1]);valor_anterior2=Number(args[2]);gain=Number(args[3]);tao1=Number(args[4]);tao2=Number(args[5]);dt=Number(args[6])}var valor_actual;valor_actual=(valor_anterior*dt*tao1+2*valor_anterior*tao2-valor_anterior2*tao2+gain*entrada*dt*dt)/(dt*dt+dt*tao1+tao2);if(Array.isArray(arguments[0])){return[entrada,valor_actual,valor_anterior,gain,tao1,tao2,dt]}else{return valor_actual}}function simulacion1erOrden(entrada,valor_anterior,gain,tao,dt){if(Array.isArray(arguments[0])){var args=[...arguments].join().split(",");entrada=Number(args[0]);valor_anterior=Number(args[1]);gain=Number(args[2]);tao=Number(args[3]);dt=Number(args[4])}var valor_actual=(valor_anterior*tao+gain*entrada*dt)/(tao+dt);if(Array.isArray(arguments[0])){return[entrada,valor_actual,gain,tao,dt]}else{return valor_actual}}class ControlPID{get estados(){return[this.error_anterior,this.errorAcumulado]}set estados(estados){this.error_anterior=estados[0];this.errorAcumulado=estados[1]}constructor(kp,ki,kd,dt){this.kp=kp;this.ki=ki;this.kd=kd;this.dt=dt;this.errorAcumulado=0;this.error_anterior=null}static accionP(kp,error){return kp*error}static accionI(ki,errorAcumulado0,dt){if(ki==0)return 0;return ki*errorAcumulado0*dt}static accionD(kd,error,error_anterior,dt){if(kd==0)return 0;return kd*(error-error_anterior)/dt}procesar=error=>{if(ki!=0){this.errorAcumulado+=error}else{this.errorAcumulado=0}if(kd!=0){if(this.error_anterior==null&&error!=null){this.error_anterior=error}}else{this.error_anterior=0}var accion_ctrl=ControlPID.accionP(this.kp,error)+ControlPID.accionI(this.ki,this.errorAcumulado,this.dt)+ControlPID.accionD(this.kd,error,this.error_anterior,this.dt);if(kd!=0){this.error_anterior=error}else{this.error_anterior=0}return accion_ctrl};resta(sp,sensorSalida){return sp-sensorSalida}}class Doble{constructor(sysPositivo,sysNegativo){this.sysPositivo=sysPositivo;this.sysNegativo=sysNegativo}reset=()=>{this.sysPositivo.reset();this.sysNegativo.reset()};procesar=entrada=>{if(entrada>=0){return this.sysNegativo.procesar(0)+this.sysPositivo.procesar(entrada)}else{return this.sysPositivo.procesar(0)+this.sysNegativo.procesar(entrada)}}}class DobleNoLineal extends Doble{constructor(sysPositivo,sysNegativo){super(sysPositivo,sysNegativo)}procesar=entrada=>{if(entrada>=0){this.sysNegativo.procesar(0);return this.sysPositivo.procesar(entrada)}else{this.sysPositivo.procesar(0);return this.sysNegativo.procesar(entrada)}}}class Satura{constructor(min,max){this.min=min;this.max=max}reset=()=>{};procesar=entrada=>{var out;out=Math.min(entrada,this.max);out=Math.max(out,this.min);return out}}class Gain{constructor(k){this.gain=k}reset=()=>{};procesar=entrada=>this.gain*entrada}class Derivador{constructor(k,valor_anterior,dt){this.valor_acumulado=valor_anterior;this.valor_inicial=valor_anterior;this.k=k;this.dt=dt;this.valor_anterior=this.valor_inicial}reset=()=>{this.valor_anterior=this.valor_inicial};procesar=entrada=>{var ret=this.k/this.dt*(entrada-this.valor_anterior);this.valor_anterior=ret;return ret}}class Integrador{constructor(k,valor_anterior,dt){this.valor_acumulado=valor_anterior;this.valor_inicial=valor_anterior;this.k=k;this.dt=dt;this.valor_anterior=this.valor_inicial}reset=()=>{this.valor_anterior=this.valor_inicial};procesar=entrada=>{var ret=this.valor_anterior+this.k*entrada*this.dt;this.valor_anterior=ret;return ret}}class Sistema1{get estados(){return[this.valor_anterior]}set estados(estados){this.valor_anterior=estados[0]}constructor(gain,tao,valor_inicial,dt){this.gain=gain;this.tao=tao;this.valor_anterior=valor_inicial;this.valor_inicial=valor_inicial;this.dt=dt;this.valor_anterior=this.valor_inicial}reset=()=>{this.valor_anterior=this.valor_inicial};procesar=entrada=>{var ret=simulacion1erOrden(entrada,this.valor_anterior,this.gain,this.tao,this.dt);this.valor_anterior=ret;return ret}}class Sistema2{get estados(){return[this.valor_anterior,this.valor_anterior2]}set estados(estados){this.valor_anterior=estados[0];this.valor_anterior2=estados[1]}constructor(gain,tao1,tao2,valor_inicial1,valor_inicial2,dt){this.gain=gain;this.tao=tao1;this.tao2=tao2;this.valor_anterior=valor_inicial1;this.valor_anterior2=valor_inicial2;this.valor_inicial=valor_inicial1;this.valor_inicial2=valor_inicial2;this.dt=dt;this.valor_anterior=this.valor_inicial}reset=()=>{this.valor_anterior=this.valor_inicial;this.valor_anterior2=this.valor_inicial2};procesar=entrada=>{var ret=simulacion2doOrden(entrada,this.valor_anterior,this.valor_anterior2,this.gain,this.tao,this.tao2,this.dt);this.valor_anterior2=this.valor_anterior;this.valor_anterior=ret;return ret}}function getOrCompute(value){if(typeof value==="function"){return value()}else{return value}}function loop_repeat_n(fun,input,n){var arr_evol=Array();if(n==0){}for(var index=0;index<n;index++){arr_evol.push(fun(getOrCompute(input)))}return arr_evol}function composeFeedback(funArr,arg1){function retf(firstInput){var ret;if(funArr.length<2)return;ret=funArr[funArr.length-1](getOrCompute(arg1),getOrCompute(firstInput));for(var index=funArr.length-2;index>=0;index--){ret=funArr[index](ret)}return ret}return retf}function P(k){return new Gain(k)}function I(dt){return new Integrador(1,0,dt)}function D(dt){return new Derivador(1,0,dt)}function Cascada(objArr){function retf(firstInput){if(typeof firstInput.procesar=="undefined"){var aux=firstInput;firstInput=new Object;firstInput.procesar=aux}return objArr.reduce(((previo,currentValue)=>currentValue.procesar(previo)),getOrCompute(firstInput.procesar))}var ret=new Object;ret.procesar=retf;return ret}function composeInv(funArr){var arrFun=funArr.reverse();return compose(arrFun)}function compose(funArr){if(funArr.length<2)return;function retf(firstInput){var first=getOrCompute(firstInput);var ret=funArr[funArr.length-1](first);for(var index=funArr.length-2;index>=0;index--){ret=funArr[index](ret)}return ret}return retf}function composeReduceInv(funArr){var arrFun=funArr.reverse();return composeReduce(arrFun)}function composeReduce(funArr){var arrFun=funArr.reverse();function retf(firstInput){return arrFun.reduce(((previo,currentValue)=>currentValue(previo)),getOrCompute(firstInput))}return retf}function loop_compose_n(fun,firstInput,n){var arr_evol=Array();if(n==0){}if(n>0){arr_evol.push(fun(getOrCompute(firstInput)))}for(var index=1;index<n;index++){arr_evol.push(fun(arr_evol[index-1]))}return arr_evol}function calculaTao(arr_evol,sp,dt){var idx=arr_evol.indexOf(arr_evol.find((x=>x>=sp*.632)));if(idx>0){var tao=Math.round(100*idx*dt)/100;console.log("tao_calculado:"+tao+" n_tao="+tao/dt+" T (s por muestra)="+dt)}else{console.log("no llega a 63.2")}return idx}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}function round2(x){return Math.round(100*x)/100}function jsonPrint(jsonObjFull){var jsonObj=JSON.parse(JSON.stringify(jsonObjFull));var jsonStr="";Object.keys(jsonObj).forEach((function(key){var val=jsonObj[key];jsonStr+=key+"="+(isNumeric(val)?round2(val):val)+" "}));return jsonStr}const widthBrowser=typeof window!="undefined"?parseInt(window.getComputedStyle(document.body).width)/9:null;const widthCmdLine=typeof process!="undefined"?process.stdout.columns:null;const n0=Math.round(widthCmdLine!=null?widthCmdLine*.9:widthBrowser*.9);class Record{constructor(){this.data=[];this.item=0}reset=()=>{this.item=0};rec=x=>{this.data.push(x);return x};play=()=>this.data[this.item++];getLast=()=>this.data[this.data-1]}const SALIDA_OPEN_LOOP=0;const SET_POINT=1;const SALIDA_CONTROL=2;const ACCION_CONTROL=3;function simularCore(set_point,sys_sensor,sys,sys_actuador,kp,ki,kd,minAcc,maxAcc,n=null){if(n==null){n=n0}n=parseInt(n);var dt0=sys.dt;var dt=dt0==null?.05:dt0;sys.reset();var r_sp=new Record;loop_repeat_n(r_sp.rec,set_point,n);var arr_sistema_open_loop;r_sp.reset();arr_sistema_open_loop=loop_repeat_n(sys.procesar,r_sp.play,n);var ctrl=new ControlPID(kp,ki,kd,dt);var ctrl2=new ControlPID(kp,ki,kd,dt);r_sp.reset();sys.reset();var r_err=new Record;var r_pre_act=new Record;var r_act=new Record;var r_out=new Record;if(sys_actuador==null){sys_actuador=new Gain(1)}if(sys_sensor==null){sys_sensor=new Gain(1)}var sat=new Satura(minAcc,maxAcc);sys_actuador.reset();sys_sensor.reset();var open_loop_path=composeReduceInv([r_err.rec,ctrl2.procesar,r_pre_act.rec,sys_actuador.procesar,sat.procesar,r_act.rec,sys.procesar,r_out.rec,sys_sensor.procesar]);var arr_salida_sensor=loop_compose_n(composeFeedback([open_loop_path,ctrl2.resta],r_sp.play),sys.valor_inicial,n);var arr_salida_controlada=r_out.data.slice();var arr_err=r_err.data.slice();var arr_act_ctrl=r_act.data.slice();var arr_set_point=r_sp.data.slice();arr_sistema_open_loop.unshift(sys.valor_inicial);arr_salida_controlada.unshift(sys.valor_inicial);arr_err.unshift(0);arr_act_ctrl.unshift(0);arr_set_point.unshift(0);return[arr_sistema_open_loop,arr_set_point,arr_salida_controlada,arr_err,arr_act_ctrl]}var simulacion=(set_point,sys_sensor,sys,sys_actuador,kp,ki,kd,minAcc,maxAcc,n=null,drawHere=null)=>{n=parseInt(n);var[arr_sistema_open_loop,arr_set_point,arr_salida_controlada,arr_err,arr_act_ctrl]=simularCore(set_point,sys_sensor,sys,sys_actuador,kp,ki,kd,minAcc,maxAcc,n);var lastSp=arr_set_point[arr_set_point.length-1];var lastOut;lastOut=arr_salida_controlada[arr_salida_controlada.length-1];var lastAction=arr_act_ctrl[arr_act_ctrl.length-1];var lastSpShow=typeof lastSp==="undefined"||isNaN(lastSp)?0:lastSp.toFixed(1);var lastError=lastSpShow-lastOut;var firstPart=" sp "+lastSpShow+" ——>(";var pidSTR=(kp!=0?"P":"")+(ki!=0?"I":"")+(kd!=0?"D":"");var secondPart;if(sys_actuador==null){secondPart="err "+lastError.toFixed(1)+"——>[CTRL "+pidSTR+"]——acc "+lastAction.toFixed(1)+"—————>[SYS]"}else{secondPart="err "+lastError.toFixed(1)+"——>[CTRL "+pidSTR+"]——acc "+lastAction.toFixed(1)+"—(A)—>[SYS]"}var lastOutShow=lastOut.toFixed(1);var line1=firstPart+" )——"+secondPart+"———>O———> out "+lastOutShow+"";var line2=Array(firstPart.length).fill(" ").join("")+"│-     "+Array(secondPart.length).fill(" ").join("")+" │";var line3;if(sys_sensor==null){line3=Array(firstPart.length).fill(" ").join("")+"│      "+Array(secondPart.length).fill(" ").join("")+" │"}else{line3=Array(firstPart.length).fill(" ").join("")+"│      "+Array(secondPart.length).fill(" ").join("")+"(S)"}var line4=Array(firstPart.length).fill(" ").join("")+"└──────"+Array(secondPart.length).fill("─").join("")+"─┘";var line5=" n:"+n;if(drawHere==null){console.log(line1);console.log(line2);console.log(line3);console.log(line4);console.log(line5)}else{drawHere(line1+"\n"+line2+"\n"+line3+"\n"+line4+"\n"+line5)}return[arr_sistema_open_loop,arr_set_point,arr_salida_controlada,arr_err,arr_act_ctrl]};export{simulacion,simularCore,Sistema1,Sistema2,ControlPID,loop_repeat_n,loop_compose_n,simulacion1erOrden,simulacion2doOrden,Derivador,Integrador,Gain,Satura,Doble};if(typeof window!="undefined"){window.simulacion=simulacion;window.Sistema1=Sistema1;window.Sistema2=Sistema2;window.loop_repeat_n=loop_repeat_n;window.loop_compose_n=loop_compose_n;window.Integrador=Integrador;window.Derivador=Derivador;window.Gain=Gain;window.Satura=Satura;window.Doble=Doble}else{var sp=100;var r=1e3;var l=.9;var c=.0022;var tao1=r*c;var kp=.1;var ki=2;var kd=.4;var accionMax=1e3;var accionMin=-1e3;var ini=0;var gain=1;var dt=.01}